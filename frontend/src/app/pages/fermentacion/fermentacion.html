<div class="page">

  <h2>Fermentaci√≥n</h2>

  <!-- LOADING -->
  <div *ngIf="cargando" class="loading">
    Cargando lotes...
  </div>

  <!-- EMPTY STATE -->
  <div *ngIf="!cargando && lotes.length === 0" class="empty">
    No hay lotes en fermentaci√≥n
  </div>

  <!-- TABLA PRINCIPAL -->
  <table *ngIf="!cargando && lotes.length > 0" class="tabla">
    <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Fecha Compra</th>
        <th>Proveedor</th>
        <th>Estado</th>
        <th>√öltimo Evento</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let lote of lotes">
        <td>{{ lote.codigo }}</td>
        <td>{{ lote.fecha_compra | date:'dd/MM/yyyy' }}</td>
        <td>{{ lote.proveedor_nombre }}</td>
        <td>
          <span class="badge" [ngClass]="{
              'badge-ready': lote.estado === 'LISTO_PARA_FERMENTACION',
              'badge-active': lote.estado === 'FERMENTACION'
            }">
            {{ lote.estado }}
          </span>
        </td>
        <td>
          {{ lote.ultimo_evento || 'Sin eventos' }}
        </td>
        <td>
          <button class="btn-primary" (click)="abrirPanel(lote)">
            Registrar Evento
          </button>
        </td>
      </tr>
    </tbody>
  </table>

</div>


<!-- OVERLAY PANEL -->
<div class="overlay" *ngIf="mostrarPanel && loteSeleccionado">

  <div class="panel">

    <button class="cerrar" (click)="cerrarPanel()">‚úï</button>

    <!-- HEADER PANEL -->
    <div class="panel-header">
      <h3>
        Fermentaci√≥n - {{ loteSeleccionado.codigo }}
      </h3>

      <button class="btn-primary" (click)="mostrarFormulario = !mostrarFormulario">
        + Nuevo Evento
      </button>
    </div>

    <!-- MENSAJE TOAST -->
    <div *ngIf="mostrarMensaje" class="toast" [ngClass]="{
        'toast-success': tipoMensaje === 'success',
        'toast-error': tipoMensaje === 'error'
        }">
      {{ mensaje }}
    </div>

    <!-- TABLA DE EVENTOS -->
    <table class="tabla-eventos" *ngIf="eventos.length > 0">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Tipo</th>
          <th>Caj√≥n</th>
          <th>¬∞Brix</th>
          <th>pH Pepa</th>
          <th>pH Pulpa</th>
          <th>Temp Int.</th>
          <th>Temp Amb.</th>
          <th>Prueba Corte</th>
          <th>Foto</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of eventos; let i = index">
          <td>{{ e.fecha | date:'dd/MM/yyyy' }}</td>
          <td>{{ e.hora || '-' }}</td>
          <td>
            <ng-container *ngIf="e.tipo === 'REMOCION'; else normalTipo">
              {{ contarRemocionActual(i) }}¬∞ REMOCI√ìN
            </ng-container>

            <ng-template #normalTipo>
              {{ e.tipo }}
            </ng-template>
          </td>
          <td>{{ e.cajon || '-' }}</td>
          <td>{{ e.brix || '-' }}</td>
          <td>{{ e.ph_pepa || '-' }}</td>
          <td>{{ e.ph_pulpa || '-' }}</td>
          <td>{{ e.temperatura_interna || '-' }}</td>
          <td>{{ e.temperatura_ambiente || '-' }}</td>
          <td>
            <span [ngClass]="e.prueba_corte ? 'badge-si' : 'badge-no'">
              {{ e.prueba_corte ? 'S√ç' : 'NO' }}
            </span>
          </td>
          <td>
            <a *ngIf="e.foto_url" [href]="e.foto_url" target="_blank" class="link-foto">
              üì∑ Ver foto
            </a>
            <ng-container *ngIf="!e.foto_url">
              <button *ngIf="editandoFotoId !== e.id" class="btn-add-foto" (click)="iniciarSubirFoto(e)">
                üì∑ + Agregar
              </button>
              <!-- Mini form subir foto -->
              <div *ngIf="editandoFotoId === e.id" class="mini-foto-form">
                <input type="file" accept="image/*" (change)="onFotoEventoSelected($event)" class="file-input-mini">
                <input type="text" placeholder="Descripci√≥n (opcional)" [(ngModel)]="descripcionEvento"
                  class="input-desc-mini">
                <div class="mini-foto-actions">
                  <button class="btn-mini-save" (click)="guardarFotoEvento(e)" [disabled]="subiendoFoto">
                    {{ subiendoFoto ? 'Subiendo...' : 'Guardar' }}
                  </button>
                  <button class="btn-mini-cancel" (click)="cancelarSubirFoto()">‚úï</button>
                </div>
              </div>
            </ng-container>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- SIN EVENTOS -->
    <div *ngIf="eventos.length === 0" class="empty">
      Este lote a√∫n no tiene eventos registrados.
    </div>

    <!-- FORMULARIO NUEVO EVENTO -->
    <div *ngIf="mostrarFormulario" class="formulario-evento">

      <h4>Registrar Evento</h4>

      <div class="form-grid">

        <!-- TIPO -->
        <div class="form-group">
          <label>Tipo de Evento</label>
          <select [(ngModel)]="nuevoEvento.tipo" name="tipo">
            <option value="INICIO">INICIO</option>
            <option value="REMOCION">REMOCI√ìN</option>
            <option value="CONTROL">CONTROL</option>
            <option value="FINAL">FINAL</option>
          </select>
        </div>

        <!-- FECHA -->
        <div class="form-group">
          <label>Fecha</label>
          <input type="date" [(ngModel)]="nuevoEvento.fecha" name="fecha">
        </div>

        <!-- HORA -->
        <div class="form-group">
          <label>Hora</label>
          <input type="time" [(ngModel)]="nuevoEvento.hora" name="hora">
        </div>

        <!-- CAJONES -->
        <div class="form-group">
          <label>Cajones</label>
          <input type="text" placeholder="Ej: 15, 16, 17" [(ngModel)]="nuevoEvento.cajon" name="cajon">
        </div>

        <!-- BRIX -->
        <div class="form-group">
          <label>¬∞Brix</label>
          <input type="number" placeholder="0.00" [(ngModel)]="nuevoEvento.brix" name="brix">
        </div>

        <!-- pH PEPA -->
        <div class="form-group">
          <label>pH Pepa</label>
          <input type="number" placeholder="0.00" [(ngModel)]="nuevoEvento.ph_pepa" name="ph_pepa">
        </div>

        <!-- pH PULPA -->
        <div class="form-group">
          <label>pH Pulpa</label>
          <input type="number" placeholder="0.00" [(ngModel)]="nuevoEvento.ph_pulpa" name="ph_pulpa">
        </div>

        <!-- TEMP INTERNA -->
        <div class="form-group">
          <label>Temp. Interna (¬∞C)</label>
          <input type="number" placeholder="0.00" [(ngModel)]="nuevoEvento.temperatura_interna" name="temp_int">
        </div>

        <!-- TEMP AMBIENTE -->
        <div class="form-group">
          <label>Temp. Ambiente (¬∞C)</label>
          <input type="number" placeholder="0.00" [(ngModel)]="nuevoEvento.temperatura_ambiente" name="temp_amb">
        </div>

        <!-- PRUEBA DE CORTE -->
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="nuevoEvento.prueba_corte" name="corte">
            Prueba de Corte
          </label>
        </div>

        <!-- SUBIR FOTO (solo si prueba de corte) -->
        <div class="form-group foto-group" *ngIf="nuevoEvento.prueba_corte">
          <label>Foto de Prueba de Corte</label>
          <input type="file" accept="image/*" (change)="onFileSelected($event)" class="file-input">
          <div *ngIf="previewUrl" class="foto-preview">
            <img [src]="previewUrl" alt="Preview" class="preview-img">
            <button class="btn-remove-foto" (click)="eliminarFoto()">‚úï Quitar</button>
          </div>
          <div *ngIf="subiendoFoto" class="uploading">
            Subiendo foto...
          </div>
        </div>

      </div>

      <div class="acciones">
        <button class="btn-secondary" (click)="mostrarFormulario = false">
          Cancelar
        </button>

        <button class="btn-primary" (click)="guardarEvento()" [disabled]="subiendoFoto">
          {{ subiendoFoto ? 'Subiendo foto...' : 'Guardar Evento' }}
        </button>
      </div>

    </div>


  </div>

</div>